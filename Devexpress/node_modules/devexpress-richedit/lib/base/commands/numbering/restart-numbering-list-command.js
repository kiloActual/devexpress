"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var numbering_list_history_items_1 = require("../../../core/model/history/items/numbering-list-history-items");
var list_1 = require("@devexpress/utils/lib/utils/list");
var search_1 = require("@devexpress/utils/lib/utils/search");
var command_states_1 = require("../command-states");
var numbering_list_command_base_1 = require("./numbering-list-command-base");
var RestartNumberingListCommand = (function (_super) {
    tslib_1.__extends(RestartNumberingListCommand, _super);
    function RestartNumberingListCommand() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    RestartNumberingListCommand.prototype.getState = function (options) {
        if (options === void 0) { options = this.convertToCommandOptions(undefined); }
        var subDocument = options.subDocument;
        var state = new command_states_1.IntervalCommandStateEx(this.isEnabled(), list_1.ListUtils.deepCopy(options.intervalsInfo.intervals));
        state.visible = false;
        if (state.enabled) {
            var startParagraphIndex = search_1.SearchUtils.normedInterpolationIndexOf(subDocument.paragraphs, function (p) { return p.startLogPosition.value; }, options.intervalsInfo.position);
            var paragraph = subDocument.paragraphs[startParagraphIndex];
            if (paragraph.isInList()) {
                var abstractNumberingListIndex = paragraph.getAbstractNumberingListIndex();
                for (var i = startParagraphIndex - 1, prevParagraph; prevParagraph = subDocument.paragraphs[i]; i--) {
                    if (prevParagraph.getAbstractNumberingListIndex() === abstractNumberingListIndex &&
                        prevParagraph.listLevelIndex === paragraph.listLevelIndex) {
                        state.visible = true;
                        break;
                    }
                }
            }
            state.enabled = state.visible;
        }
        return state;
    };
    RestartNumberingListCommand.prototype.executeCore = function (_state, options) {
        var subDocument = options.subDocument;
        var startParagraphIndex = search_1.SearchUtils.normedInterpolationIndexOf(subDocument.paragraphs, function (paragraph) { return paragraph.startLogPosition.value; }, options.intervalsInfo.position);
        this.history.beginTransaction();
        var firstParagraph = subDocument.paragraphs[startParagraphIndex];
        var listType = firstParagraph.getNumberingList().getListType();
        var templateIndex = this.getNumberingListTemplateIndex(listType);
        var newListIndex = this.createNewList(this.control.modelManager.model.abstractNumberingListTemplates[templateIndex]);
        var startParagraphAbstractNumberingListIndex = firstParagraph.getAbstractNumberingListIndex();
        for (var i = startParagraphIndex, paragraph; paragraph = subDocument.paragraphs[i]; i++) {
            if (paragraph.getAbstractNumberingListIndex() === startParagraphAbstractNumberingListIndex)
                this.history.addAndRedo(new numbering_list_history_items_1.AddParagraphToListHistoryItem(this.modelManipulator, subDocument, i, newListIndex, paragraph.getListLevelIndex()));
        }
        this.history.endTransaction();
        return true;
    };
    return RestartNumberingListCommand;
}(numbering_list_command_base_1.NumberingListCommandBase));
exports.RestartNumberingListCommand = RestartNumberingListCommand;
